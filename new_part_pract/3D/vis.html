<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Arena 3D Battle Visualizer</title>
  <style>
    :root{
      --bg:#0b0f1a;--bg2:#0e1424;--panel:#121b30;--panel2:#0f1a33;
      --accent:#2dd4bf;--accent2:#8b5cf6;--text:#e5ecff;--muted:#94a3b8;--danger:#ef4444;--ok:#22c55e;--warn:#f59e0b;
      --border:#1f2a44;--chip:#1b2540;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;padding:0;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      overflow:hidden;
    }
    .wrap{display:flex;flex-direction:column;height:100%}
    header{
      padding:14px 18px;border-bottom:1px solid var(--border);
      display:flex;gap:16px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,var(--panel),var(--panel2));
      position:relative;z-index:2;
    }
    header .ttl{display:flex;align-items:center;gap:10px}
    header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
    header .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      background:#1a2644;border:1px solid var(--border);color:var(--text);
      padding:8px 12px;border-radius:10px;cursor:pointer;transition:all .15s ease;font-weight:600
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(135deg,#1f8a81,#2563eb);border-color:#2563eb}
    .btn.warn{background:#3a2a14;border-color:#7c4a00}
    .btn.ok{background:#11351f;border-color:#1b8a52}
    .btn.danger{background:#381417;border-color:#7a1d27}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .tog{display:flex;align-items:center;gap:8px}
    .tog input{transform:scale(1.2)}
    .speed{display:flex;align-items:center;gap:8px}
    .layout{display:flex;flex:1 1 auto;min-height:0}
    .viewer{position:relative;flex:1 1 auto;min-width:0}
    #threejs-container{position:absolute;inset:0}
    .overlay-hint{position:absolute;left:50%;top:16px;transform:translateX(-50%);background:#0f172a88;padding:8px 12px;border:1px solid var(--border);border-radius:10px;font-size:12px}
    aside{
      width:320px;max-width:35vw;border-left:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel2));
      display:flex;flex-direction:column;gap:12px;padding:12px;overflow:auto
    }
    .card{background:#0d142a;border:1px solid var(--border);border-radius:14px;padding:12px}
    .card h3{margin:0 0 6px;font-size:14px;letter-spacing:.3px}
    .row{display:flex;gap:10px}
    .stat{flex:1 1 0;background:#0c1326;border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
    .stat .v{font-weight:800;font-size:20px}
    .stat.red{border-color:#7f1d1d}
    .stat.blue{border-color:#1d4ed8}
    .kv{display:flex;justify-content:space-between;padding:4px 0;color:var(--muted);font-size:12px}
    .timeline input[type=range]{width:100%}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .robot-info{min-height:110px;max-height:180px;overflow:auto;font-size:12px}
    .drop{border:2px dashed #334155;border-radius:14px;background:#0b1226;padding:14px;text-align:center;cursor:pointer}
    .drop.drag{background:#0d1530;border-color:#64748b}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hidden{display:none !important}
    @media (max-width: 1000px){aside{width:280px}}
    @media (max-width: 860px){
      .layout{flex-direction:column}
      aside{width:100%;max-width:none;height:40vh}
      .viewer{height:60vh}
    }
  </style>
</head>
<body>
  <!-- –ì–ª–æ–±–∞–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π drop/dragover, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª JSON –∫–∞–∫ —Ç–µ–∫—Å—Ç -->
  <script>
    document.addEventListener('dragover', e => e.preventDefault(), false);
    document.addEventListener('drop', e => e.preventDefault(), false);
  </script>

  <div class="wrap">
    <header>
      <div class="ttl">
        <div style="font-size:20px">üõ∞Ô∏è</div>
        <div>
          <h1>Arena 3D Battle Visualizer</h1>
          <div class="sub">3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—ë–≤ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –ø–æ–ª—è –∏ —Ä–∞–¥–∏—É—Å–æ–º –ª–∞–∑–µ—Ä–∞</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="btnLoad">üìÇ Load Battle JSON</button>
        <input type="file" id="fileInput" accept=".json" class="hidden"/>

        <button class="btn ok" id="btnPlay">‚ñ∂ Play</button>
        <button class="btn" id="btnPause">‚è∏ Pause</button>
        <button class="btn danger" id="btnReset">‚ü≤ Reset</button>

        <span class="speed">
          <span>Speed:</span>
          <input type="range" id="speed" min="0.2" max="3" step="0.1" value="1"/>
          <span id="speedVal" class="chip mono">1.0x</span>
        </span>

        <label class="tog">
          <input type="checkbox" id="toggleTrails" checked/>
          <span>Show Trails</span>
        </label>
        <label class="tog">
          <input type="checkbox" id="toggleBounds" checked/>
          <span>Show Bounds</span>
        </label>
      </div>
    </header>

    <div class="layout">
      <section class="viewer">
        <div id="threejs-container"></div>
        <div class="overlay-hint muted mono" id="hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ battle_3d_*.json</div>
      </section>

      <aside>
        <div class="card drop" id="dropZone">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ 3D battle JSON —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>

        <div class="card">
          <h3>üìä Battle Stats</h3>
          <div class="row">
            <div class="stat red">
              <div>Red Team HP</div>
              <div class="v" id="redHP">0</div>
            </div>
            <div class="stat blue">
              <div>Blue Team HP</div>
              <div class="v" id="blueHP">0</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="stat">
              <div>Alive</div>
              <div class="v" id="aliveCount">0</div>
            </div>
            <div class="stat">
              <div>Time</div>
              <div class="v" id="battleTime">0s</div>
            </div>
          </div>
        </div>

        <div class="card timeline">
          <h3>‚è∞ Timeline</h3>
          <input type="range" id="frame" min="0" max="0" value="0"/>
          <div class="kv"><span>Frame: <span id="cur">0</span></span><span>Total: <span id="tot">0</span></span></div>
        </div>

        <div class="card">
          <h3>üì∑ Camera</h3>
          <div class="grid">
            <button class="btn" data-cam="overview">üèüÔ∏è Overview</button>
            <button class="btn" data-cam="side">üìê Side</button>
            <button class="btn" data-cam="top">‚¨áÔ∏è Top</button>
            <button class="btn" data-cam="follow">üéØ Follow</button>
          </div>
          <div class="muted" style="margin-top:8px">
            üñ±Ô∏è Rotate/Zoom ‚Ä¢ ‚§¢ Right-click: Pan
          </div>
        </div>

        <div class="card">
          <h3>ü§ñ Robot Info</h3>
          <div id="robotInfo" class="robot-info">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —Ä–æ–±–æ—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏</div>
        </div>

        <div class="card">
          <h3>üéûÔ∏è Recent Events</h3>
          <div id="events" class="robot-info">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- –£–º–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ THREE + OrbitControls —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ CDN –∏ –æ—Ñ–ª–∞–π–Ω-—Ñ–æ–ª–±–µ–∫–æ–º -->
  <script>
    async function loadScript(src){return new Promise(r=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=r;s.onerror=r;document.head.appendChild(s);});}
    async function ensureThree(){
      if (window.THREE) return;
      const localThree = './three.min.js';           // –æ—Ñ–ª–∞–π–Ω-—Ñ–∞–π–ª —Ä—è–¥–æ–º —Å vis.html (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      const localCtrl  = './OrbitControls.js';       // –æ—Ñ–ª–∞–π–Ω-—Ñ–∞–π–ª —Ä—è–¥–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      const threeCDN = [
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js',
        'https://unpkg.com/three@0.152.2/build/three.min.js',
        'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js'
      ];
      const ctrlCDN = [
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/examples/js/controls/OrbitControls.js',
        'https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js',
        'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js'
      ];
      // –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã, –∑–∞—Ç–µ–º CDN
      const tryList = async (arr)=>{for(const u of arr){await loadScript(u); if (window.THREE) return true;} return false;}
      if (!(await tryList([localThree,...threeCDN]))) console.warn('THREE.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –Ω–∏ —Å –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
      if (window.THREE && !THREE.OrbitControls){
        await tryList([localCtrl,...ctrlCDN]);
      }
    }
  </script>

  <script>
    class Visualizer {
      constructor(){
        // –¥–∞–Ω–Ω—ã–µ
        this.data=null; this.frames=[]; this.bounds=null; this.laser=null;
        this.cur=0; this.isPlay=false; this.speed=1; this.showBounds=true; this.showTrails=true;
        this.recent=[]; this.robots=new Map(); this.trails=new Map(); this.followId=null;

        // UI
        this.$=id=>document.getElementById(id);
        this.hookUI();
        this.hookFile();

        // 3D –ø–æ–ø–æ–∑–∂–µ (–ø–æ—Å–ª–µ ensureThree). –ù–æ –µ—Å–ª–∏ THREE —É–∂–µ –µ—Å—Ç—å ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É.
        try{ if (window.THREE) this.init3D(); }catch(e){ console.error('init3D error (early):',e); }
      }

      hookUI(){
        this.$('btnLoad').onclick=()=>this.$('fileInput').click();
        this.$('btnPlay').onclick=()=>this.play();
        this.$('btnPause').onclick=()=>this.pause();
        this.$('btnReset').onclick=()=>this.reset();

        this.$('speed').addEventListener('input',e=>{
          this.speed=Number(e.target.value)||1; this.$('speedVal').textContent=this.speed.toFixed(1)+'x';
        });
        this.$('toggleTrails').addEventListener('change',e=>{this.showTrails=e.target.checked;});
        this.$('toggleBounds').addEventListener('change',e=>{
          this.showBounds=e.target.checked;
          if(this.fieldGroup) this.fieldGroup.visible=this.showBounds;
        });

        // timeline
        this.$('frame').addEventListener('input',e=>{
          this.cur = Math.min(this.frames.length-1, Number(e.target.value)||0);
          this.updateFrame(true);
        });

        // camera preset buttons
        document.querySelectorAll('[data-cam]').forEach(b=>{
          b.addEventListener('click',()=>this.setCam(b.dataset.cam));
        });
      }

      hookFile(){
        const input=this.$('fileInput');
        const drop =document.getElementById('dropZone');
        input.onchange=(e)=>{ if(e.target.files && e.target.files[0]) this.loadFile(e.target.files[0]); };
        drop.addEventListener('click',()=>input.click());
        drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
        drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
        drop.addEventListener('drop',e=>{
          e.preventDefault(); drop.classList.remove('drag');
          const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(f) this.loadFile(f);
        });
      }

      async loadFile(file){
        const txt = await file.text();
        let json=null;
        try{ json=JSON.parse(txt); }
        catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON'); return; }
        this.ingest(json);
      }

      ingest(json){
        // –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç BattleRecording3D
        this.data=json;
        this.frames = Array.isArray(json.frames)? json.frames : [];
        this.bounds = json.field_bounds || (this.frames[0]?.field_bounds) || {x_min:-10,x_max:10,y_min:-8,y_max:8,z_min:0,z_max:6};
        this.laser  = json.laser_config || {max_range:8,damage:15,accuracy_falloff:0.1};

        // UI
        this.$('tot').textContent=this.frames.length;
        this.$('frame').max=this.frames.length? (this.frames.length-1):0;
        this.$('hint').classList.add('hidden');

        // 3D
        if(!this.scene && window.THREE){
          try{ this.init3D(); }catch(e){ console.error('init3D error (late):',e); }
        }
        // —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.pause(); this.cur=0; this.updateFrame(true);
      }

      /* ================== 3D ================== */
      init3D(){
        if (!window.THREE) throw new Error('THREE.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');

        const cont = document.getElementById('threejs-container');
        // —Å—Ü–µ–Ω–∞
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.Fog(0x0b1020, 30, 80);

        // –∫–∞–º–µ—Ä–∞
        const w=cont.clientWidth||800, h=cont.clientHeight||600;
        this.camera = new THREE.PerspectiveCamera(60, w/h, 0.1, 500);
        this.camera.position.set(18, 14, 18);

        // —Ä–µ–Ω–¥–µ—Ä
        this.renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
        this.renderer.setPixelRatio(window.devicePixelRatio||1);
        this.renderer.setSize(w,h);
        this.renderer.setClearColor(0x071019,1);
        cont.innerHTML='';
        cont.appendChild(this.renderer.domElement);

        // controls
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping=true; this.controls.dampingFactor=.08;
        this.controls.minDistance=4; this.controls.maxDistance=80;

        // —Å–≤–µ—Ç
        const a=new THREE.AmbientLight(0xffffff,.35); this.scene.add(a);
        const d=new THREE.DirectionalLight(0xffffff,.9); d.position.set(16,24,12); d.castShadow=true; this.scene.add(d);

        // –ø–æ–ª–µ
        this.fieldGroup = new THREE.Group(); this.scene.add(this.fieldGroup);
        this.buildField();

        // –∫–ª–∏–∫–∏ –ø–æ —Ä–æ–±–æ—Ç–∞–º
        this.renderer.domElement.addEventListener('click',e=>this.onClick(e));

        // —Ä–µ—Å–∞–π–∑
        window.addEventListener('resize',()=>{const w=cont.clientWidth,h=cont.clientHeight; this.camera.aspect=w/h; this.camera.updateProjectionMatrix(); this.renderer.setSize(w,h);});

        // —Ä–µ–Ω–¥–µ—Ä-–ª—É–ø
        const loop = ()=>{
          requestAnimationFrame(loop);
          if(this.controls) this.controls.update();
          if(this.trails.size) this.updateTrails();
          this.renderer.render(this.scene,this.camera);
        };
        loop();
      }

      buildField(){
        if(!this.bounds) return;
        const b=this.bounds; const W=b.x_max-b.x_min, H=b.y_max-b.y_min, D=b.z_max-b.z_min;

        // –ø–ª–æ—Å–∫–æ—Å—Ç—å
        const g = new THREE.PlaneGeometry(W, H);
        const m = new THREE.MeshBasicMaterial({color:0x0b2a3a,transparent:true,opacity:.25});
        const plane = new THREE.Mesh(g,m); plane.rotation.x=-Math.PI/2;
        plane.position.set((b.x_min+b.x_max)/2, b.z_min, (b.y_min+b.y_max)/2);
        this.fieldGroup.add(plane);

        // —Å–µ—Ç–∫–∞
        const grid = new THREE.GridHelper(Math.max(W,H), 20, 0x274c77, 0x274c77);
        grid.position.set(plane.position.x, b.z_min+0.01, plane.position.z);
        this.fieldGroup.add(grid);

        // ¬´–∫–æ—Ä–æ–±–∫–∞¬ª –≥—Ä–∞–Ω–∏—Ü
        const box = new THREE.Box3(
          new THREE.Vector3(b.x_min,b.z_min,b.y_min),
          new THREE.Vector3(b.x_max,b.z_max,b.y_max)
        );
        const helper = new THREE.Box3Helper(box, 0x3b82f6);
        this.fieldGroup.add(helper);

        this.fieldGroup.visible=this.showBounds;
      }

      /* ================== –†–µ–Ω–¥–µ—Ä –∏ –∫–∞–¥—Ä—ã ================== */
      createRobotMesh(data){
        const group=new THREE.Group(); group.name=data.id;

        const body=new THREE.Mesh(
          new THREE.BoxGeometry(.6, .6, .6),
          new THREE.MeshStandardMaterial({color:data.team==='red'?0xff5757:0x5b8dff,metalness:.1,roughness:.6})
        );
        body.castShadow=true; body.position.y=.3;
        group.add(body);

        // —Å—Ç–≤–æ–ª/–ª–∞–∑–µ—Ä
        const gun=new THREE.Mesh(
          new THREE.CylinderGeometry(0.05,0.05,0.6,10),
          new THREE.MeshStandardMaterial({color:0xffe066,emissive:0x332200,emissiveIntensity:.4})
        );
        gun.rotation.z=Math.PI/2; gun.position.set(.5,.35,0); gun.name='gun';
        group.add(gun);

        // HP
        const hpbg=new THREE.Mesh(new THREE.PlaneGeometry(.9,.08), new THREE.MeshBasicMaterial({color:0x334155}));
        hpbg.position.set(0,1.0,0.01); hpbg.rotation.y=0; group.add(hpbg);
        const hp=new THREE.Mesh(new THREE.PlaneGeometry(.9,.08), new THREE.MeshBasicMaterial({color:0x22c55e}));
        hp.position.set(0,1.0,0.02); hp.name='hp'; group.add(hp);

        group.userData={selected:false};
        return group;
      }

      updateRobotMesh(group,data){
        group.position.set(data.x, data.z, data.y);
        // –∑–¥–æ—Ä–æ–≤—å–µ
        const hp = group.getObjectByName('hp');
        const w = Math.max(0, Math.min(1, (data.hp||0)/100));
        hp.scale.x = w; hp.position.x = (w-1)*0.45;

        // —Ç—É—Å–∫–Ω–µ–µ–º –µ—Å–ª–∏ –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –∏–ª–∏ –º—ë—Ä—Ç–≤
        const scaleAlive = data.alive?1:0.6;
        group.scale.set(scaleAlive,scaleAlive,scaleAlive);
        if (!data.within_bounds || !data.alive){
          group.traverse(o=>{if(o.isMesh && o.material && o.material.color){o.material.color.offsetHSL(0, -0.2, -0.2);}});
        }

        // —Å–ª–µ–¥—ã
        if (this.showTrails && data.alive){
          if(!this.trails.has(data.id)) this.trails.set(data.id, []);
          const t=this.trails.get(data.id);
          t.push(new THREE.Vector3(group.position.x, group.position.y+0.02, group.position.z));
          if(t.length>60) t.shift();
        }

        // –ª–∞–∑–µ—Ä–Ω—ã–π –∏–º–ø—É–ª—å—Å (–≤ –ø—Ä–æ—Å—Ç–æ–º –≤–∏–¥–µ)
        if (data.fire_action && data.alive){
          const laser = new THREE.Mesh(
            new THREE.CylinderGeometry(0.025,0.025,1.0,8),
            new THREE.MeshBasicMaterial({color:0xfff090,transparent:true,opacity:.9})
          );
          laser.position.copy(group.position).add(new THREE.Vector3(0,0.5,0));
          laser.rotation.x=Math.PI/2;
          this.scene.add(laser);
          let o=1;
          const fade=()=>{o-=.06; laser.material.opacity=o; if(o<=0) this.scene.remove(laser); else requestAnimationFrame(fade);}
          setTimeout(fade,80);
        }
      }

      updateTrails(){
        for (const [id, points] of this.trails.entries()){
          if (points.length<2) continue;
          if (!this.trailsLines) this.trailsLines=new Map();
          let line=this.trailsLines.get(id);
          const geo=new THREE.BufferGeometry().setFromPoints(points);
          if (!line){
            line=new THREE.Line(geo, new THREE.LineBasicMaterial({color:0x93c5fd,transparent:true,opacity:.6}));
            this.trailsLines.set(id,line); this.scene.add(line);
          } else { line.geometry.dispose(); line.geometry=geo; }
        }
      }

      updateFrame(syncSlider=false){
        if(!this.frames.length || !this.scene) return;
        const fr = this.frames[this.cur];

        // —Ä–æ–±–æ—Ç—ã
        (fr.robots||[]).forEach(r=>{
          let g = this.robots.get(r.id);
          if(!g){ g=this.createRobotMesh(r); this.scene.add(g); this.robots.set(r.id,g); }
          this.updateRobotMesh(g,r);
        });

        // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        let rHP=0,bHP=0,alive=0;
        (fr.robots||[]).forEach(r=>{
          if(r.team==='red'){ if(r.alive) rHP+=r.hp; }
          else { if(r.alive) bHP+=r.hp; }
          if (r.alive) alive++;
        });
        this.$('redHP').textContent=Math.round(rHP);
        this.$('blueHP').textContent=Math.round(bHP);
        this.$('aliveCount').textContent=alive;

        // –≤—Ä–µ–º—è
        const t0 = (this.data.start_time||0); // –∏–∑ —Ñ–∞–π–ª–∞
        const t  = (fr.timestamp||0) - t0;
        this.$('battleTime').textContent= (t>0? t.toFixed(1):'0')+'s';

        // –∫–∞—Ä–∫–∞—Å —Ç–∞–π–º–ª–∞–π–Ω–∞
        if(syncSlider){
          this.$('cur').textContent=this.cur;
          this.$('frame').value=this.cur;
        }

        // —Å–æ–±—ã—Ç–∏—è
        this.renderEvents(fr.events||[]);
      }

      renderEvents(evts){
        if(!evts.length){ this.$('events').textContent='–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç'; return; }
        const last = evts.slice(-8).reverse();
        this.$('events').innerHTML = last.map(e=>{
          const type = e.type || 'event';
          const robot = e.robot_id || e.robot || '';
          const tgt = e.target_id ? ` ‚Üí ${e.target_id}` : '';
          const dist = (e.distance!=null)? ` ‚Ä¢ d=${Number(e.distance).toFixed(2)}`:'';
          return `<div class="kv"><span>${type}</span><span class="mono">${robot}${tgt}${dist}</span></div>`;
        }).join('');
      }

      onClick(e){
        if(!this.renderer || !this.camera) return;
        const rect=this.renderer.domElement.getBoundingClientRect();
        const mouse = new THREE.Vector2(((e.clientX-rect.left)/rect.width)*2-1, -((e.clientY-rect.top)/rect.height)*2+1);
        const ray = new THREE.Raycaster(); ray.setFromCamera(mouse, this.camera);
        const objs = Array.from(this.robots.values());
        const it = ray.intersectObjects(objs,true);
        if(!it.length) return;
        const node = it[0].object;
        let g=node; while (g.parent && !this.robots.has(g.name)) g=g.parent;
        if(!this.robots.has(g.name)) return;
        this.followId=g.name;
        this.$('robotInfo').innerHTML=`<div class="kv"><span>ID</span><span class="mono">${g.name}</span></div><div class="kv"><span>Follow</span><span>ON</span></div>`;
        this.setCam('follow');
      }

      setCam(preset){
        if(!this.bounds || !this.camera || !this.controls) return;
        const cx=(this.bounds.x_min+this.bounds.x_max)/2;
        const cy=(this.bounds.y_min+this.bounds.y_max)/2;
        const cz=(this.bounds.z_min+this.bounds.z_max)/2;
        if(preset==='overview'){ this.camera.position.set(cx+18, cz+14, cy+18); this.controls.target.set(cx,cz,cy); }
        else if(preset==='side'){ this.camera.position.set(cx+22, cz+10, cy); this.controls.target.set(cx,cz,cy); }
        else if(preset==='top'){ this.camera.position.set(cx, cz+28, cy); this.controls.target.set(cx,cz,cy); }
        else if(preset==='follow' && this.followId && this.robots.get(this.followId)){
          const g=this.robots.get(this.followId);
          this.camera.position.lerp(new THREE.Vector3(g.position.x+4,g.position.y+3,g.position.z+6),.6);
          this.controls.target.copy(g.position);
        }
        this.controls.update();
      }

      play(){
        if(!this.frames.length) return;
        this.isPlay=true;
        const step=()=>{
          if(!this.isPlay) return;
          if(this.cur < this.frames.length-1){ this.cur++; this.updateFrame(true); setTimeout(step, 100/this.speed); }
          else this.isPlay=false;
        };
        step();
      }
      pause(){ this.isPlay=false; }
      reset(){ this.pause(); this.cur=0; this.updateFrame(true); }
    }

    // –∑–∞–ø—É—Å–∫–∞–µ–º
    window.addEventListener('load', async ()=>{
      window.visualizer = new Visualizer();
      await ensureThree();                         // –ø–æ–¥–≥—Ä—É–∑–∏–º THREE/Controls, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
      if (!window.visualizer.scene && window.THREE){
        try{ window.visualizer.init3D(); }catch(e){ console.error('init3D error (post-load):',e); }
      }
    });
  </script>
</body>
</html>
